name: Deploy Hindsight AI with Docker Compose

on:
  push:
    branches: [ main, staging ]
  workflow_dispatch:
    inputs:
      recreate_acme_json:
        description: "Recreate acme.json for Let's Encrypt"
        required: true
        type: boolean
        default: false

jobs:
  hindsight-service-tests:
    name: Hindsight Service (pytest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/hindsight-service
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup uv
        uses: astral-sh/setup-uv@v3

      - name: Run tests
        run: uv run --extra test pytest --maxfail=1 -q

  dashboard-tests:
    name: Dashboard (Jest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/hindsight-dashboard
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/hindsight-dashboard/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Jest (coverage)
        run: npm run test:coverage -- --ci

  build-and-push-hindsight-service:
    needs: [hindsight-service-tests, dashboard-tests]
    runs-on: ubuntu-latest
    # Select environment based on branch so we can use env-scoped secrets
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get backend version
        id: backend-version
        run: |
          VERSION=$(cat apps/hindsight-service/pyproject.toml | grep -E "^version\s*=" | sed -E 's/version\s*=\s*"([^"]+)"$/\1/')
          echo "BACKEND_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Set build timestamp
        id: build-timestamp
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "BUILD_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      - name: Build and push Hindsight Service Docker image
        id: build-push-service
        uses: docker/build-push-action@v5
        with:
          context: apps/hindsight-service
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/hindsight-service:${{ github.sha }}
            ${{ github.ref == 'refs/heads/main' && format('ghcr.io/{0}/hindsight-service:latest', github.repository_owner) || '' }}
            ${{ github.ref == 'refs/heads/staging' && format('ghcr.io/{0}/hindsight-service:staging-latest', github.repository_owner) || '' }}
          file: apps/hindsight-service/Dockerfile
          build-args: |
            BUILD_SHA=${{ github.sha }}
            BUILD_TIMESTAMP=${{ env.BUILD_TIMESTAMP }}
            IMAGE_TAG=ghcr.io/${{ github.repository_owner }}/hindsight-service:${{ github.sha }}
            VERSION=${{ env.BACKEND_VERSION }}

  build-and-push-hindsight-dashboard:
    needs: [hindsight-service-tests, dashboard-tests]
    runs-on: ubuntu-latest
    # Select environment based on branch so we can use env-scoped secrets
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get frontend version
        id: frontend-version
        run: |
          VERSION=$(cat apps/hindsight-dashboard/package.json | jq -r '.version')
          echo "FRONTEND_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Set build timestamp
        id: build-timestamp
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "BUILD_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      - name: Build and push Hindsight Dashboard Docker image
        id: build-push-dashboard
        uses: docker/build-push-action@v5
        with:
          context: apps/hindsight-dashboard
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/hindsight-dashboard:${{ github.sha }}
            ${{ github.ref == 'refs/heads/main' && format('ghcr.io/{0}/hindsight-dashboard:latest', github.repository_owner) || '' }}
            ${{ github.ref == 'refs/heads/staging' && format('ghcr.io/{0}/hindsight-dashboard:staging-latest', github.repository_owner) || '' }}
          file: apps/hindsight-dashboard/Dockerfile
          build-args: |
            VITE_VERSION=${{ env.FRONTEND_VERSION }}
            VITE_BUILD_SHA=${{ github.sha }}
            VITE_BUILD_TIMESTAMP=${{ env.BUILD_TIMESTAMP }}
            VITE_DASHBOARD_IMAGE_TAG=ghcr.io/${{ github.repository_owner }}/hindsight-dashboard:${{ github.sha }}

  deploy:
    needs: [build-and-push-hindsight-service, build-and-push-hindsight-dashboard]
    runs-on: ubuntu-latest
    # Run on both branches, pick the environment dynamically
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    concurrency:
      group: deploy-${{ github.ref }}
      cancel-in-progress: true

    env:
      # Derived values based on selected environment
      ENV_NAME: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
      SERVER_DIR: ${{ github.ref == 'refs/heads/main' && 'hindsight-ai-production' || 'hindsight-ai-staging' }}
      COMPOSE_FILE: docker-compose.app.yml

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy files to remote server via scp
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "${{ env.COMPOSE_FILE }},config/,templates/,letsencrypt/"
          target: "~/${{ env.SERVER_DIR }}"

      - name: Execute deployment commands on remote server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail
            cd ~/${{ env.SERVER_DIR }}

            # Create .env file
            echo "Creating .env file for ${{ env.ENV_NAME }}..."
            cat <<EOF > .env
            HINDSIGHT_SERVICE_IMAGE=ghcr.io/${{ github.repository_owner }}/hindsight-service:${{ github.sha }}
            HINDSIGHT_DASHBOARD_IMAGE=ghcr.io/${{ github.repository_owner }}/hindsight-dashboard:${{ github.sha }}
            APP_HOST=${{ secrets.APP_HOST }}
            TRAEFIK_DASHBOARD_HOST=${{ secrets.TRAEFIK_DASHBOARD_HOST }}
            CLOUDFLARE_DNS_EMAIL=${{ secrets.CLOUDFLARE_DNS_EMAIL }}
            CLOUDFLARE_DNS_API_TOKEN=${{ secrets.CLOUDFLARE_DNS_API_TOKEN }}
            OAUTH2_PROXY_CLIENT_ID=${{ secrets.OAUTH2_PROXY_CLIENT_ID }}
            OAUTH2_PROXY_CLIENT_SECRET=${{ secrets.OAUTH2_PROXY_CLIENT_SECRET }}
            OAUTH2_PROXY_COOKIE_SECRET='${{ secrets.OAUTH2_PROXY_COOKIE_SECRET }}'
            LLM_API_KEY=${{ secrets.LLM_API_KEY }}
            LLM_MODEL_NAME=${{ secrets.LLM_MODEL_NAME }}
            CONSOLIDATION_BATCH_SIZE=${{ secrets.CONSOLIDATION_BATCH_SIZE }}
            FALLBACK_SIMILARITY_THRESHOLD=${{ secrets.FALLBACK_SIMILARITY_THRESHOLD }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            HINDSIGHT_SERVICE_API_URL=${{ secrets.API_URL }}
            BACKEND_BUILD_SHA=${{ github.sha }}
            FRONTEND_BUILD_SHA=${{ github.sha }}
            BUILD_TIMESTAMP=${{ env.BUILD_TIMESTAMP }}
            BACKEND_IMAGE_TAG=ghcr.io/${{ github.repository_owner }}/hindsight-service:${{ github.sha }}
            FRONTEND_IMAGE_TAG=ghcr.io/${{ github.repository_owner }}/hindsight-dashboard:${{ github.sha }}
            EOF

            # Create authorized_emails.txt
            echo "Creating authorized_emails.txt for ${{ env.ENV_NAME }}..."
            echo "${{ secrets.AUTHORIZED_EMAILS_CONTENT }}" > authorized_emails.txt

            # Replace email placeholder in Traefik config (use the same secret name in both envs)
            echo "Replacing email placeholder in Traefik config..."
            sed -i 's/<email_placeholder>/${{ secrets.ACME_EMAIL }}/g' ./config/traefik.yml

            # Conditionally recreate acme.json for Let's Encrypt
            if [ "${{ github.event.inputs.recreate_acme_json }}" = "true" ]; then
              echo "Recreating acme.json for ${{ env.ENV_NAME }}..."
              mkdir -p ./letsencrypt
              rm -f ./letsencrypt/acme.json
              touch ./letsencrypt/acme.json
              chmod 600 ./letsencrypt/acme.json
            else
              echo "Skipping acme.json recreation for ${{ env.ENV_NAME }}."
            fi

            # Authenticate with GitHub Container Registry
            echo "Authenticating with GitHub Container Registry..."
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Decide profile flag for production only
            PROFILE_FLAG=""
            if [ "${{ env.ENV_NAME }}" = "production" ]; then
              PROFILE_FLAG="--profile prod"
            fi

            # Pull new images and deploy
            echo "Pulling new images and deploying to ${{ env.ENV_NAME }}..."
            docker compose -f ${{ env.COMPOSE_FILE }} pull || true
            docker compose -f ${{ env.COMPOSE_FILE }} ${PROFILE_FLAG} up -d --force-recreate

            # Simple health check: wait 10 seconds and verify containers are still running
            echo "Performing simple health check - waiting 10 seconds..."
            sleep 10

            # Check if key containers are still running
            if docker compose -f ${{ env.COMPOSE_FILE }} ps | grep -E "(hindsight-service|hindsight-dashboard|traefik|oauth2-proxy)" | grep -q "Up"; then
              echo "✅ All ${{ env.ENV_NAME }} containers are running and stable"
              echo "🎉 Deployment successful!"
            else
              echo "❌ Some ${{ env.ENV_NAME }} containers crashed or stopped"
              echo "Container status:"
              docker compose -f ${{ env.COMPOSE_FILE }} ps
              echo "Recent logs:"
              docker compose -f ${{ env.COMPOSE_FILE }} logs --tail 20
              exit 1
            fi
