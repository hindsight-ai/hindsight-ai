name: Build, Push, and Deploy Hindsight AI to K3s

on:
  push:
    branches: [ main ] # Triggers the workflow on every push to the main branch

jobs:
  # --- JOB 1: Build and Push Hindsight Service Docker Image ---
  build-and-push-hindsight-service:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # Permission needed to push images to GHCR

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # Automatically generated by GitHub

      - name: Build and push Hindsight Service Docker image
        id: build-push-service
        uses: docker/build-push-action@v5
        with:
          context: apps/hindsight-service # Context is the hindsight-service directory
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/hindsight-service:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/hindsight-service:latest
          file: apps/hindsight-service/Dockerfile # Specify the Dockerfile path

  # --- JOB 2: Build and Push Hindsight Dashboard Docker Image ---
  build-and-push-hindsight-dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Hindsight Dashboard Docker image
        id: build-push-dashboard
        uses: docker/build-push-action@v5
        with:
          context: apps/hindsight-dashboard # Context is the hindsight-dashboard directory
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/hindsight-dashboard:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/hindsight-dashboard:latest
          file: apps/hindsight-dashboard/Dockerfile # Specify the Dockerfile path

  # --- JOB 3: Deploy Images to K3s Server ---
  deploy:
    needs: [build-and-push-hindsight-service, build-and-push-hindsight-dashboard] # Waits for both build jobs to complete
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "Connection successful, deployment in progress..."
            
            # Apply Kubernetes manifests
            # Ensure the k8s directory is present on the server or clone the repo
            # For simplicity, we assume the k8s directory is available or will be cloned.
            # A better approach for production might be to use kustomize or helm.
            
            # Apply all manifests in the k8s directory
            kubectl apply -f k8s/
            
            # Update the image of the hindsight-service deployment
            kubectl set image deployment/hindsight-service-deployment hindsight-service=ghcr.io/${{ github.repository_owner }}/hindsight-service:latest
            
            # Update the image of the hindsight-dashboard deployment
            kubectl set image deployment/hindsight-dashboard-deployment hindsight-dashboard=ghcr.io/${{ github.repository_owner }}/hindsight-dashboard:latest
            
            echo "Deployment completed!"
