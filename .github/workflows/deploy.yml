name: Build, Push, and Deploy Hindsight AI to K3s

on:
  push:
    branches: [ main ] # Triggers the workflow on every push to the main branch

jobs:
  # --- JOB 1: Build and Push Hindsight Service Docker Image ---
  build-and-push-hindsight-service:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # Permission needed to push images to GHCR

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # Automatically generated by GitHub

      - name: Build and push Hindsight Service Docker image
        id: build-push-service
        uses: docker/build-push-action@v5
        with:
          context: apps/hindsight-service # Context is the hindsight-service directory
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/hindsight-service:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/hindsight-service:latest
          file: apps/hindsight-service/Dockerfile # Specify the Dockerfile path

  # --- JOB 2: Build and Push Hindsight Dashboard Docker Image ---
  build-and-push-hindsight-dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Hindsight Dashboard Docker image
        id: build-push-dashboard
        uses: docker/build-push-action@v5
        with:
          context: apps/hindsight-dashboard # Context is the hindsight-dashboard directory
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/hindsight-dashboard:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/hindsight-dashboard:latest
          file: apps/hindsight-dashboard/Dockerfile # Specify the Dockerfile path
          build-args: |
            REACT_APP_HINDSIGHT_SERVICE_API_URL=http://46.62.141.65/api

  # --- JOB 3: Deploy Images to K3s Server ---
  deploy:
    needs: [build-and-push-hindsight-service, build-and-push-hindsight-dashboard] # Waits for both build jobs to complete
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "Connection successful, deployment in progress..."
            
            # Define a temporary directory for cloning the repository
            REPO_DIR="/tmp/${{ github.repository }}"
            
            # Clean up previous clone if it exists
            if [ -d "$REPO_DIR" ]; then
              echo "Removing existing repository clone at $REPO_DIR"
              rm -rf "$REPO_DIR"
            fi
            
            # Clone the repository to access k8s manifests
            echo "Cloning repository ${{ github.repository }} into $REPO_DIR"
            # Use HTTPS with GITHUB_TOKEN for authentication
            git clone https://github.com/${{ github.repository }}.git "$REPO_DIR"
            
            # Navigate to the cloned repository
            cd "$REPO_DIR"
            
            # Install Traefik Resource Definitions and RBAC for Traefik
            echo "Applying Traefik CRDs..."
            sudo kubectl apply -f https://raw.githubusercontent.com/traefik/traefik/v3.3/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml
            sudo kubectl apply -f https://raw.githubusercontent.com/traefik/traefik/v3.3/docs/content/reference/dynamic-configuration/kubernetes-crd-rbac.yml
            
            echo "Waiting for CRDs to be registered..."
            sleep 10 # Give Kubernetes time to register the CRDs
            
            # Replace placeholder in k8s manifests with actual GitHub username
            echo "Replacing YOUR_GITHUB_USERNAME placeholder in k8s manifests..."
            sed -i "s/YOUR_GITHUB_USERNAME/${{ github.repository_owner }}/g" k8s/*.yaml
            
            # Create image pull secret for GitHub Container Registry
            echo "Creating image pull secret for GitHub Container Registry..."
            sudo kubectl create secret docker-registry ghcr-login-secret \
              --docker-server=ghcr.io \
              --docker-username=${{ github.actor }} \
              --docker-password=${{ secrets.GHCR_PAT }} \
              --dry-run=client -o yaml | sudo kubectl apply -f -
            
            # Apply all Kubernetes manifests in the k8s directory
            echo "Applying Kubernetes manifests from $REPO_DIR/k8s/"
            sudo kubectl apply -f k8s/

            # Copy backup/restore scripts to a common location and make them executable
            echo "Copying backup and restore scripts to /usr/local/bin/"
            sudo cp "$REPO_DIR"/infra/scripts/backup-script-for-k8s.sh /usr/local/bin/hindsight-db-backup.sh
            sudo cp "$REPO_DIR"/infra/scripts/restore-script-for-k8s.sh /usr/local/bin/hindsight-db-restore.sh
            sudo chmod +x /usr/local/bin/hindsight-db-backup.sh
            sudo chmod +x /usr/local/bin/hindsight-db-restore.sh
            echo "Scripts copied and made executable."

            # Add cronjob to run the backup script hourly
            echo "Adding hourly backup cronjob..."
            (crontab -l 2>/dev/null; echo "0 * * * * /usr/local/bin/hindsight-db-backup.sh >> /var/log/hindsight-db-backup.log 2>&1") | crontab -
            echo "Hourly backup cronjob added."
            
            # Update the image of the hindsight-service deployment
            echo "Updating hindsight-service deployment image"
            sudo kubectl set image deployment/hindsight-service-deployment hindsight-service=ghcr.io/${{ github.repository_owner }}/hindsight-service:latest
            
            # Update the image of the hindsight-dashboard deployment
            echo "Updating hindsight-dashboard deployment image"
            sudo kubectl set image deployment/hindsight-dashboard-deployment hindsight-dashboard=ghcr.io/${{ github.repository_owner }}/hindsight-dashboard:latest
            
            echo "Triggering rollout restart for deployments..."
            sudo kubectl rollout restart deployment/hindsight-service-deployment
            sudo kubectl rollout restart deployment/hindsight-dashboard-deployment
            
            echo "Deployment commands executed."
            
            # Clean up the cloned repository
            echo "Cleaning up cloned repository at $REPO_DIR"
            cd - # Go back to the previous directory
            rm -rf "$REPO_DIR"
            
            echo "Deployment completed!"
